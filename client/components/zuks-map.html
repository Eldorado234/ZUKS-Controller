<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/leaflet-map/leaflet-map.html">
<link rel="import" href="../bower_components/core-style/core-style.html">

<script src="../bower_components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.js"></script>

<polymer-element name="zuks-map" attributes="volunteers selectedVolunteers">
  <template>
    <style>
    :host {
      display: block;
      height: 100%;
    }

    leaflet-map {
      width: 100%;
      height: 100%;
    }
    </style>
    
    <leaflet-map
      longitude="8.238611"
      latitude="50.083056"
      zoom="14"
      id="map"
      on-contextmenu="{{clickedRight}}">
        <core-style id="map-style">
          <link rel="stylesheet" href="../bower_components/font-awesome/css/font-awesome.css" />
          <link rel="stylesheet" href="../bower_components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.css" />
        </core-style>
        <template repeat="{{volunteer in volunteers}}">
          <leaflet-marker longitude="{{volunteer.location.longitude}}" 
                        latitude="{{volunteer.location.latitude}}"
                        on-click="{{volunteerSelected}}"
                        icon="{{volunteer.selected | iconForState}}">
          </leaflet-marker>
        </template>
    </leaflet-map>

  </template>
  <script>
  Polymer({
    hilightMarker: L.AwesomeMarkers.icon({markerColor: 'red'}),
    defaultMarker: L.AwesomeMarkers.icon({markerColor: 'blue'}),
    clickedRight: function(e) {
      if (e.detail && e.detail.latlng) {
        this.fire('volunteer-added', {
          latitude: e.detail.latlng.lat,
          longitude: e.detail.latlng.lng
        });
      }
    },
    selectedVolunteersChanged: function(changes) {
      var self = this;
      $(changes).each(function(changeI, change) {
          $(change.removed).each(function() {
            this.selected = false;
          });
          if (change.addedCount > 0) {
            for(var i=0; i < change.addedCount; i++) {
              self.selectedVolunteers[change.index + i].selected = true;
            }
          }
      });
    },
    volunteerSelected: function(event) {
      var volunteer = event.target.templateInstance.model.volunteer;
      this.fire('volunteer-select', volunteer);
    },
    iconForState: function(state) {
      return state ? this.hilightMarker : this.defaultMarker;
    }
  });
  </script>
</polymer-element>
