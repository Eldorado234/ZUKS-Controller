<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/core-overlay/core-overlay.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/core-icons/maps-icons.html">

<polymer-element name="zuks-volunteer-list" attributes="volunteerGroups selectedVolunteers">
  <template>
    <style>
    :host {
      display: block;
      height: 100%;
    }

    core-list {
      height: 100%;
    }

    .item {
      height: 70px;
      padding-right: 16px;
      padding-left: 16px;
      padding-top: 4px;
      padding-bottom: 4px;
    }

    .item.selected .container {
      background: #eee;
    }

    .container, paper-shadow {
      height: 100%;
    }

    .divider {
      color: #888;
      padding-left: 16px;
      padding-top: 16px;
      padding-bottom: 4px;
    }

    .content {
      padding-left: 10px;
    }

    .devider paper-button {
      margin:0;
    }

    </style>

    <core-list data="{{volunteerGroups.values | flattenGroup}}" groups="{{volunteerGroups.values}}" multi selection="{{selectedVolunteers}}" id="volunteerList" selectionenabled>
      <template>
        <div divider class="divider">
          {{groupModel.name}}
        </div>
        <div class="item {{ {selected: selected} | tokenList }}">
          <paper-shadow>
            <div horizontal layout center class="container">
              <div class="content">{{model.first_name}} {{model.last_name}}</div>
            </div>
            <paper-ripple fit></paper-ripple>
          </paper-shadow>
        </div>
      </template>
    </core-list>

    <paper-action-dialog heading="{{selectedVolunteers.length > 1 ? selectedVolunteers.length + ' Helfer ausgewÃ¤hlt' : selectedVolunteers[0].first_name + ' ' + selectedVolunteers[0].last_name}}" id="volunteerDetail" autoCloseDisabled on-core-overlay-position="{{layoutVolunteerOverlay}}" on-core-overlay-close-completed="{{volunteerOverlayClosed}}">
        <template if="{{selectedVolunteers.length > 1}}">
          <div>
            <template repeat="{{volunteer, i in selectedVolunteers}}">
              <span>{{volunteer.first_name}} {{volunteer.last_name}}{{(i < selectedVolunteers.length - 1) ? ',' : ''}}</span>
            </template>
          </div>
        </template>

        <div horizontal layout>
          <paper-icon-button icon="maps:my-location" on-click="{{locate}}"></paper-icon-button>
        </div>
        <paper-dropdown-menu label="Gruppe">
            <paper-dropdown layered class="dropdown">
                <core-menu class="menu" valueattr="gid" selected="{{selectedGroup}}">
                    <template repeat="{{group in volunteerGroups.values}}">
                        <paper-item gid="{{group.id}}">{{group.name}}</paper-item>
                    </template>
                </core-menu>
            </paper-dropdown>
        </paper-dropdown-menu>

        <paper-button dismissive>Abbrechen</paper-button>
        <paper-button affirmative on-click="{{saveVolunteer}}" style="color:#4d9eff">Speichern</paper-button>
    </paper-action-dialog>

  </template>
  <script>
  Polymer({
    flattenGroup: function(groupList) {
      var volunteers = [];
      $(groupList).each(function() {
        volunteers.push(this.members);
      });
      return volunteers;
    },
    selectVolunteer: function(volunteer) {
      this.$.volunteerList.selectData(volunteer);
      this.$.volunteerList.scrollToData(volunteer);
    },
    selectedVolunteersChanged: function(changes) {
      if (this.selectedVolunteers.length > 0) {
        if (this.selectedVolunteers.length > 1) {
          this.selectedGroup = '';
        } else {
          this.selectedGroup = this.selectedVolunteers[0].group;
        }

        this.$.volunteerDetail.open();
      } else {
        this.$.volunteerDetail.close();
      }
    },
    volunteerOverlayClosed: function(event) {
      if (event.target === this.$.volunteerDetail) {
        this.$.volunteerList.clearSelection();
      }
    },
    layoutVolunteerOverlay: function(event) {
      var target = $(event.target);
      var list = $(this.$.volunteerList);

      target.css('top', $('.item', list).css('padding-top'));
      target.css('right', list.css('width'));
      target.css('margin', 0);
      target.css('max-width', '280px');

      event.target.dimensions.position = {v: 'top', h: 'right'};
    },
    saveVolunteer: function(event) {
      var editableVolunteers = [];
      this.selectedVolunteers.forEach(function(volunteer) {
        var copiedVolunteer = $.extend(true, {}, volunteer);
        copiedVolunteer.group = this.selectedGroup;
        editableVolunteers.push(copiedVolunteer);
      }, this);
      this.fire("update", editableVolunteers);
    },
    locate: function() {
      this.fire("focus-request", this.selectedVolunteers);
    }
  });
  </script>
</polymer-element>
