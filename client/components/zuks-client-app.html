<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/core-icons/maps-icons.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="zuks-service/zuks-client-service.html">
<link rel="import" href="zuks-list-item.html">

<polymer-element name="zuks-client-app">

  <!-- Global styles -->
  <style>
    html /deep/ .tintText {
      color: #4d9eff;
    }
  </style>

  <template>
    <style>
    :host {
      color: #444;
    }

    core-header-panel {
      height: 100%;
      width: 100%;
      background-color: #fff;
    }

    .core-header {
      background-color: #4d9eff;
      height: 60px;
      color: white;
    }

    .core-header img {
      height: 40px;
      margin: 10px;
    }
    
    #login paper-input{
      margin-left: 12px;
      margin-right: 12px; 
    }

    #login paper-button {
      float: right;
    }

    .item {
      padding: 8px;
      padding-bottom: 0;
    }

    paper-shadow {
      border-radius: 2px;
      padding: 16px;
      transition: transform 0.4s;
    }

    :host /deep/ h1 {
      margin-top: 0;
      font-size: 1.3em;
    }

    paper-shadow.deleted {
      transform: translateX(100%);
    }

    paper-icon-button, paper-spinner {
      position: absolute;
      top: 0;
      right: 0;
      z-index: 1;
    }

    #locationButton, paper-spinner {
      padding: 16px;
    }

    </style>

    <zuks-client-service instructions="{{instructions}}" user="{{user}}" id="service"></zuks-client-service>

    <core-header-panel mode="waterfall" fullbleed>
      <div class="core-header" center>
        <img src="https://www.zuks.org/static/img/logo/logo-weiss%401200.png">
        <template if="{{!requestingLocation}}">
          <paper-icon-button icon="maps:my-location" id="locationButton" on-click="{{locate}}"></core-icon-button>
        </template>
        <template if="{{requestingLocation}}">
          <paper-spinner active></paper-spinner>
        </template>
      </div>
    
    
      <template if="{{!user.id}}">
        <div id="login" vertical layout>
          <paper-input label="Vorname" value="{{user.first_name}}" autofocus floatingLabel></paper-input>
          <paper-input label="Nachname" value="{{user.last_name}}" floatingLabel></paper-input>
          <div>
            <paper-button class="tintText" on-click="{{register}}">Anmelden</paper-button>
          <div>
        </div>
      </template>

      <template if="{{user.id}}">
        <template repeat="{{instruction, index in instructions}}">
            <div class="item">
              <paper-shadow>
                <h1>{{instruction.subject}}</h1>
                <paper-icon-button icon="close" on-click="{{dismissCard}}"></paper-icon-button>
                {{instruction.content}}
              </paper-shadow>
            </div>
          </template>
      </template>
    </core-header-panel>

  </template>
  <script>
  Polymer({
    requestingLocation: false,
    ready: function() {
      this.selectedTab = 0;
      CoreStyle.g.paperInput.focusedColor = '#4d9eff';
      this.instructions.push({
        subject: "Herzlich Willkommen",
        content: "Schön dass du bei dieser Präsentation mit machst. Schließe Karten einfach mit dem x oben rechts."
      });
      this.instructions.unshift({
        subject: "Wo bist du?",
        content: "Gib doch bitte deinen Standort frei, damit wir dich auch auf dem Beamer vorne sehen. Einfach oben rechts auf das Icon drücken. DATENSCHUTZ wird bei mir groß geschrieben, versprochen!"
      });
    },
    register: function() {
      this.$.service.register();
    },
    dismissCard: function(event) {
      var item = event.target.parentElement;
      var index = event.target.templateInstance.model.index;
      item.classList.add('deleted');
      this.async(function() {
        this.instructions.splice(index, 1);
      }, this, 300);
    },
    locate: function() {
      if ("geolocation" in navigator) {
        this.requestingLocation = true;
        navigator.geolocation.getCurrentPosition(function(position) {
            this.instructions.unshift({
            subject: "Gefunden",
            content: "Habe deinen Standort gefunden - schau mal nach vorne auf den Beamer!"
          });
          this.requestingLocation = false;
          this.user.location = position.coords;
          this.$.service.updateUser();
        }.bind(this));
      } else {
        this.instructions.unshift({
          subject: "Kann dich nicht finden",
          content: "Mit deinem Browser kann dein Standort leider nicht abgerufen werden. Ich denke mir einen aus."
        });
        this.user.location = {
          latitude: 50.097777 + this.getRandomLocationOffset(),
          longitude: 8.216612 + this.getRandomLocationOffset()
        };
        this.$.service.updateUser();
      }
    },
    getRandomLocationOffset: function() {
      return Math.random() * 0.006 - 0.003;
    }
  });
  </script>
</polymer-element>
